<h2>Управление экспериментами</h2>

{% if messages %}
  <ul>
    {% for m in messages %}<li>{{ m }}</li>{% endfor %}
  </ul>
{% endif %}

<!-- 1) Импорт JSON -->
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <p>Загрузить файл JSON:
    <input type="file" name="json_file" accept=".json,application/json">
  </p>
  <p>или вставить JSON-текст:</p>
  <p><textarea name="json_text" rows="10" cols="80"></textarea></p>
  <button name="import" value="1">Импортировать</button>
</form>

<hr>

<!-- 2) Выбор эксперимента (GET!) -->
<form method="get">
  <label>
    <input type="checkbox" name="finished" value="1" {% if finished %}checked{% endif %}>
    Расчёты завершены
  </label>

  {{ select_form.experiment }}

  <button type="submit">Показать</button>
</form>

{% if exp %}
  <h3>{{ exp.name }} (id={{ exp.pk }})</h3>

  <!-- 3) Редактирование + запуск (POST, отдельная форма) -->
  <form method="post">
    {% csrf_token %}
    <!-- сохраняем состояние, чтобы после редиректа остаться на этом же фильтре/эксперименте -->
    <input type="hidden" name="experiment_id" value="{{ exp.pk }}">
    <input type="hidden" name="finished" value="{% if finished %}1{% else %}0{% endif %}">


    <label>Конфиги сегментов</label><br>
    <textarea rows="10" cols="80" name="config_segments">{{ segments_pretty }}</textarea>

    <label>Конфиги воронок</label><br>
    <textarea rows="10" cols="80" name="config_funnels">{{ funnels_pretty }}</textarea>

    <p>
      <label>Дата</label>
      <input type="datetime-local" name="date" value="{{ date_value }}">
    </p>

    <p>
      <label>Период</label>
      <select name="period">
        <option value="selected_date">Выбранная дата</option>
        <option value="from_selected_to_yesterday">С выбранной даты по вчера</option>
        <option value="all_time">За весь период</option>
      </select>
    </p>

    <p>
      <button name="save" value="1">Сохранить</button>
      <button name="run"  value="1">Запустить расчёты</button>
    </p>
  </form>
{% endif %}
